<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Art Labeler</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* LEFT PANEL - image grid */
    #sidebar {
      width: 320px;
      min-width: 260px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #sidebar-header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }

    #sidebar-header h1 {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #fff;
    }

    #progress-bar-wrap {
      margin-top: 8px;
      background: #2a2a2a;
      border-radius: 4px;
      height: 6px;
      overflow: hidden;
    }

    #progress-bar {
      height: 100%;
      background: #4ade80;
      transition: width 0.3s;
      width: 0%;
    }

    #progress-label {
      margin-top: 5px;
      font-size: 11px;
      color: #888;
    }

    #search-wrap {
      padding: 10px 12px;
      flex-shrink: 0;
      border-bottom: 1px solid #2a2a2a;
    }

    #search {
      width: 100%;
      background: #222;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 10px;
      color: #eee;
      font-size: 13px;
      outline: none;
    }

    #search:focus { border-color: #555; }

    #filter-btns {
      display: flex;
      gap: 6px;
      padding: 8px 12px;
      flex-shrink: 0;
    }

    .filter-btn {
      flex: 1;
      padding: 4px 0;
      font-size: 11px;
      background: #222;
      border: 1px solid #333;
      border-radius: 4px;
      color: #aaa;
      cursor: pointer;
    }

    .filter-btn.active {
      background: #333;
      border-color: #555;
      color: #fff;
    }

    #grid {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 68px;
      gap: 6px;
      align-content: start;
    }

    .thumb {
      background: #222;
      border: 2px solid #333;
      border-radius: 6px;
      cursor: pointer;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: relative;
      transition: border-color 0.15s;
    }

    .thumb:hover { border-color: #555; }
    .thumb.selected { border-color: #60a5fa; }
    .thumb.labeled { border-color: #4ade80; }
    .thumb.labeled.selected { border-color: #60a5fa; }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: pixelated;
      padding: 4px;
    }

    .thumb .label-dot {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #4ade80;
      display: none;
    }

    .thumb.labeled .label-dot { display: block; }

    .thumb .thumb-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      font-size: 9px;
      color: #ccc;
      text-align: center;
      padding: 2px 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      transition: opacity 0.1s;
    }

    .thumb:hover .thumb-name { opacity: 1; }

    /* RIGHT PANEL - editor */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 24px;
    }

    #empty-state {
      text-align: center;
      color: #555;
    }

    #empty-state svg {
      margin-bottom: 16px;
      opacity: 0.3;
    }

    #empty-state p { font-size: 14px; }

    #image-view {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 100%;
      max-width: 480px;
    }

    #image-view.visible { display: flex; }

    #big-image-wrap {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 480px;
    }

    #big-image {
      max-width: 480px;
      max-height: 480px;
      width: 480px;
      height: 480px;
      object-fit: contain;
      image-rendering: pixelated;
      object-fit: contain;
    }

    #image-name {
      font-size: 13px;
      color: #888;
      text-align: center;
    }

    #desc-wrap {
      width: 100%;
    }

    #desc-wrap label {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    #desc {
      width: 100%;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      color: #eee;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      min-height: 80px;
      outline: none;
      font-family: inherit;
    }

    #desc:focus { border-color: #60a5fa; }

    #btn-row {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    #btn-save {
      flex: 1;
      padding: 10px;
      background: #2563eb;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }

    #btn-save:hover { background: #1d4ed8; }
    #btn-save:disabled { background: #1e3a5f; color: #6b7280; cursor: default; }

    #btn-clear {
      padding: 10px 16px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      color: #aaa;
      font-size: 14px;
      cursor: pointer;
    }

    #btn-clear:hover { background: #333; color: #eee; }

    #nav-row {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    #btn-prev, #btn-next {
      flex: 1;
      padding: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #aaa;
      font-size: 13px;
      cursor: pointer;
    }

    #btn-prev:hover, #btn-next:hover { background: #222; color: #eee; }

    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #4ade80;
      color: #111;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <h1>Pixel Art Labeler</h1>
    <div id="progress-bar-wrap"><div id="progress-bar"></div></div>
    <div id="progress-label">Loading...</div>
  </div>
  <div id="search-wrap">
    <input id="search" type="text" placeholder="Search images..." autocomplete="off">
  </div>
  <div id="filter-btns">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="labeled">Labeled</button>
    <button class="filter-btn" data-filter="unlabeled">Unlabeled</button>
  </div>
  <div id="grid"></div>
</div>

<div id="main">
  <div id="editor">
    <div id="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <path d="M3 9h18M9 21V9"/>
      </svg>
      <p>Select an image to add a description</p>
    </div>

    <div id="image-view">
      <div id="big-image-wrap">
        <img id="big-image" src="" alt="">
      </div>
      <div id="image-name"></div>
      <div id="desc-wrap">
        <label>Description</label>
        <textarea id="desc" placeholder="Describe this pixel art image..."></textarea>
      </div>
      <div id="btn-row">
        <button id="btn-save">Save</button>
        <button id="btn-clear">Clear</button>
      </div>
      <div id="nav-row">
        <button id="btn-prev">← Previous</button>
        <button id="btn-next">Next →</button>
      </div>
    </div>
  </div>
</div>

<div id="toast">Saved!</div>

<script>
  let images = [];
  let descriptions = {};
  let currentImage = null;
  let currentFilter = 'all';
  let filteredImages = [];

  const grid = document.getElementById('grid');
  const emptyState = document.getElementById('empty-state');
  const imageView = document.getElementById('image-view');
  const bigImage = document.getElementById('big-image');
  const imageName = document.getElementById('image-name');
  const desc = document.getElementById('desc');
  const btnSave = document.getElementById('btn-save');
  const btnClear = document.getElementById('btn-clear');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const progressBar = document.getElementById('progress-bar');
  const progressLabel = document.getElementById('progress-label');
  const searchInput = document.getElementById('search');
  const toast = document.getElementById('toast');

  async function init() {
    const [imgRes, descRes] = await Promise.all([
      fetch('/api/images'),
      fetch('/api/descriptions')
    ]);
    images = await imgRes.json();
    descriptions = await descRes.json();
    renderGrid();
    updateProgress();
  }

  function getFilteredImages() {
    const q = searchInput.value.trim().toLowerCase();
    return images.filter(img => {
      const name = img.replace('.png', '').toLowerCase();
      if (q && !name.includes(q)) return false;
      if (currentFilter === 'labeled') return !!descriptions[img];
      if (currentFilter === 'unlabeled') return !descriptions[img];
      return true;
    });
  }

  function renderGrid() {
    filteredImages = getFilteredImages();
    grid.innerHTML = '';
    for (const img of filteredImages) {
      const div = document.createElement('div');
      div.className = 'thumb' + (descriptions[img] ? ' labeled' : '') + (img === currentImage ? ' selected' : '');
      div.dataset.img = img;

      const dot = document.createElement('div');
      dot.className = 'label-dot';

      const el = document.createElement('img');
      el.src = `/images/${encodeURIComponent(img)}`;
      el.alt = img;
      el.loading = 'lazy';

      const nameEl = document.createElement('div');
      nameEl.className = 'thumb-name';
      nameEl.textContent = img.replace('.png', '');

      div.appendChild(el);
      div.appendChild(dot);
      div.appendChild(nameEl);
      div.addEventListener('click', () => selectImage(img));
      grid.appendChild(div);
    }
  }

  function updateProgress() {
    const labeled = images.filter(i => descriptions[i]).length;
    const pct = images.length ? Math.round(labeled / images.length * 100) : 0;
    progressBar.style.width = pct + '%';
    progressLabel.textContent = `${labeled} / ${images.length} labeled (${pct}%)`;
  }

  function selectImage(img) {
    currentImage = img;
    bigImage.src = `/images/${encodeURIComponent(img)}`;
    imageName.textContent = img.replace('.png', '');
    desc.value = descriptions[img] || '';
    emptyState.style.display = 'none';
    imageView.classList.add('visible');

    // Update selected state in grid
    document.querySelectorAll('.thumb').forEach(el => {
      el.classList.toggle('selected', el.dataset.img === img);
    });

    // Scroll selected thumb into view
    const selected = grid.querySelector('.thumb.selected');
    if (selected) selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });

    desc.focus();
  }

  function navigate(delta) {
    if (!currentImage) return;
    const idx = filteredImages.indexOf(currentImage);
    const next = filteredImages[idx + delta];
    if (next) selectImage(next);
  }

  async function saveDesc() {
    if (!currentImage) return;
    const text = desc.value.trim();
    if (text) {
      descriptions[currentImage] = text;
    } else {
      delete descriptions[currentImage];
    }

    await fetch('/api/descriptions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(descriptions)
    });

    // Update thumb
    const thumb = grid.querySelector(`.thumb[data-img="${CSS.escape(currentImage)}"]`);
    if (thumb) thumb.classList.toggle('labeled', !!text);

    updateProgress();
    showToast(text ? 'Saved!' : 'Cleared');

    // If filtering, re-render and move on
    if (currentFilter !== 'all') {
      renderGrid();
      const idx = filteredImages.indexOf(currentImage);
      const next = filteredImages[idx + 1] || filteredImages[idx - 1];
      if (next) selectImage(next);
    }
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1800);
  }

  // Events
  btnSave.addEventListener('click', saveDesc);

  btnClear.addEventListener('click', () => {
    desc.value = '';
    saveDesc();
  });

  btnPrev.addEventListener('click', () => navigate(-1));
  btnNext.addEventListener('click', () => navigate(1));

  document.addEventListener('keydown', e => {
    if (e.target === desc) {
      // Ctrl/Cmd+Enter to save
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        saveDesc();
      }
      return;
    }
    if (e.key === 'ArrowLeft') navigate(-1);
    if (e.key === 'ArrowRight') navigate(1);
    if (e.key === 'Enter') saveDesc();
  });

  searchInput.addEventListener('input', renderGrid);

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderGrid();
    });
  });

  init();
</script>
</body>
</html>
