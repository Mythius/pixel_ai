<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Art Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ── NAV ── */
    #nav {
      display: flex;
      align-items: center;
      gap: 0;
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
      padding: 0 16px;
      height: 46px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      height: 100%;
      padding: 0 14px;
      font-size: 13px;
      color: #888;
      text-decoration: none;
      border-bottom: 2px solid transparent;
      transition: color 0.15s;
    }

    .nav-link:hover { color: #ccc; }

    .nav-link.active {
      color: #fff;
      border-bottom-color: #60a5fa;
    }

    #nav-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-left: auto;
      padding-right: 4px;
    }

    /* ── PROMPT AREA ── */
    #prompt-section {
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #prefix-label {
      font-size: 11px;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #prefix-text {
      color: #60a5fa;
      font-family: monospace;
      font-size: 12px;
    }

    #input-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    #prompt-input {
      flex: 1;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 14px;
      color: #eee;
      font-size: 14px;
      outline: none;
      font-family: inherit;
    }

    #prompt-input:focus { border-color: #60a5fa; }
    #prompt-input::placeholder { color: #444; }

    #controls-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    #num-label {
      font-size: 12px;
      color: #666;
    }

    .num-btn {
      padding: 5px 12px;
      background: #222;
      border: 1px solid #333;
      border-radius: 6px;
      color: #aaa;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .num-btn.active {
      background: #1e3a5f;
      border-color: #2563eb;
      color: #60a5fa;
    }

    .num-btn:hover:not(.active) { background: #2a2a2a; color: #eee; }

    #btn-generate {
      padding: 9px 22px;
      background: #2563eb;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }

    #btn-generate:hover:not(:disabled) { background: #1d4ed8; }

    #btn-generate:disabled {
      background: #1e3a5f;
      color: #6b7280;
      cursor: default;
    }

    /* ── LOADING ── */
    #loading {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 0 0;
      font-size: 13px;
      color: #888;
    }

    #loading.visible { display: flex; }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── GALLERY ── */
    #gallery-section {
      flex: 1;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    #gallery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #gallery-header h2 {
      font-size: 13px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #gallery-count {
      font-size: 12px;
      color: #555;
    }

    #gallery-empty {
      text-align: center;
      color: #444;
      padding: 60px 0;
      font-size: 14px;
    }

    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 14px;
    }

    .img-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: border-color 0.15s;
    }

    .img-card:hover { border-color: #444; }

    .img-card.new-card {
      border-color: #2563eb;
      animation: flash 1.5s ease forwards;
    }

    @keyframes flash {
      0%   { border-color: #60a5fa; box-shadow: 0 0 12px #2563eb88; }
      100% { border-color: #2a2a2a; box-shadow: none; }
    }

    .card-img-wrap {
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      aspect-ratio: 1;
    }

    .card-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: pixelated;
    }

    .card-info {
      padding: 10px 12px;
      border-top: 1px solid #222;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-prompt {
      font-size: 11px;
      color: #aaa;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-ts {
      font-size: 10px;
      color: #444;
    }

    .card-download {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      font-size: 11px;
      color: #555;
      text-decoration: none;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      font-family: inherit;
    }

    .card-download:hover { color: #aaa; }

    /* ── TOAST ── */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #4ade80;
      color: #111;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      z-index: 100;
    }

    #toast.error { background: #f87171; }
    #toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body>

<!-- NAV -->
<nav id="nav">
  <a class="nav-link" href="/">Labeler</a>
  <a class="nav-link active" href="/generator">Generator</a>
  <span id="nav-title">Pixel Art AI</span>
</nav>

<!-- PROMPT SECTION -->
<div id="prompt-section">
  <div id="prefix-label">
    Prompt prefix: <span id="prefix-text">pixel image: (32x32)</span>
  </div>

  <div id="input-row">
    <input
      id="prompt-input"
      type="text"
      placeholder="a small red dragon breathing fire…"
      autocomplete="off"
    >
    <button id="btn-generate">Generate</button>
  </div>

  <div id="controls-row">
    <span id="num-label">Count:</span>
    <button class="num-btn active" data-n="1">×1</button>
    <button class="num-btn" data-n="2">×2</button>
    <button class="num-btn" data-n="4">×4</button>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    <span id="loading-text">Generating… this takes 1–3 minutes on Apple Silicon</span>
  </div>
</div>

<!-- GALLERY -->
<div id="gallery-section">
  <div id="gallery-header">
    <h2>Generated Images</h2>
    <span id="gallery-count"></span>
  </div>
  <div id="gallery-empty" style="display:none">No images generated yet. Enter a prompt above and hit Generate.</div>
  <div id="gallery"></div>
</div>

<div id="toast"></div>

<script>
  let selectedNum = 1;

  const promptInput  = document.getElementById('prompt-input');
  const btnGenerate  = document.getElementById('btn-generate');
  const loading      = document.getElementById('loading');
  const loadingText  = document.getElementById('loading-text');
  const gallery      = document.getElementById('gallery');
  const galleryEmpty = document.getElementById('gallery-empty');
  const galleryCount = document.getElementById('gallery-count');
  const toast        = document.getElementById('toast');

  // ── Num buttons ──────────────────────────────────────────────────────────
  document.querySelectorAll('.num-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedNum = parseInt(btn.dataset.n);
    });
  });

  // ── Generate (non-blocking: POST → job_id, then poll) ───────────────────
  let pollInterval = null;

  function stopPolling() {
    if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
  }

  async function pollJob(job_id, startTime) {
    try {
      const res = await fetch(`/api/generate/status/${job_id}`);
      const job = await res.json();
      const elapsed = Math.round((Date.now() - startTime) / 1000);

      if (job.status === 'pending' || job.status === 'running') {
        loadingText.textContent = `Generating… ${elapsed}s elapsed`;
        return; // keep polling
      }

      stopPolling();
      btnGenerate.disabled = false;
      loading.classList.remove('visible');

      if (job.status === 'done') {
        showToast(`Generated ${job.images.length} image${job.images.length !== 1 ? 's' : ''}!`);
        promptInput.value = '';
        await loadGallery(job.images);
      } else {
        showToast('Error: ' + (job.error || 'Unknown error'), true);
      }
    } catch (err) {
      stopPolling();
      btnGenerate.disabled = false;
      loading.classList.remove('visible');
      showToast('Error: ' + err.message, true);
    }
  }

  async function generate() {
    const prompt = promptInput.value.trim();
    if (!prompt) { promptInput.focus(); return; }

    btnGenerate.disabled = true;
    loading.classList.add('visible');
    loadingText.textContent = `Starting generation…`;

    try {
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, num: selectedNum }),
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'Unknown error');

      const startTime = Date.now();
      loadingText.textContent = `Generating… 0s elapsed`;
      pollInterval = setInterval(() => pollJob(data.job_id, startTime), 2000);

    } catch (err) {
      btnGenerate.disabled = false;
      loading.classList.remove('visible');
      showToast('Error: ' + err.message, true);
    }
  }

  btnGenerate.addEventListener('click', generate);
  promptInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') generate();
  });

  // ── Gallery ───────────────────────────────────────────────────────────────
  function formatTs(ts) {
    // ts is like "20240228_120000"
    if (!ts || ts.length < 15) return ts;
    const y = ts.slice(0, 4), mo = ts.slice(4, 6), d = ts.slice(6, 8);
    const h = ts.slice(9, 11), mi = ts.slice(11, 13), s = ts.slice(13, 15);
    return `${y}-${mo}-${d} ${h}:${mi}:${s}`;
  }

  function createCard(record, isNew = false) {
    const card = document.createElement('div');
    card.className = 'img-card' + (isNew ? ' new-card' : '');

    const imgWrap = document.createElement('div');
    imgWrap.className = 'card-img-wrap';

    const img = document.createElement('img');
    img.className = 'card-img';
    img.src = `/generated/${encodeURIComponent(record.filename)}`;
    img.alt = record.user_prompt || record.prompt;
    img.loading = 'lazy';
    imgWrap.appendChild(img);

    const info = document.createElement('div');
    info.className = 'card-info';

    const promptEl = document.createElement('div');
    promptEl.className = 'card-prompt';
    promptEl.textContent = record.user_prompt || record.prompt;

    const tsEl = document.createElement('div');
    tsEl.className = 'card-ts';
    tsEl.textContent = formatTs(record.ts);

    const dlBtn = document.createElement('a');
    dlBtn.className = 'card-download';
    dlBtn.href = `/generated/${encodeURIComponent(record.filename)}`;
    dlBtn.download = record.filename;
    dlBtn.textContent = '↓ Download';

    info.appendChild(promptEl);
    info.appendChild(tsEl);
    info.appendChild(dlBtn);

    card.appendChild(imgWrap);
    card.appendChild(info);
    return card;
  }

  async function loadGallery(newFilenames = []) {
    const res = await fetch('/api/generated-images');
    const records = await res.json();

    gallery.innerHTML = '';
    galleryEmpty.style.display = records.length === 0 ? 'block' : 'none';
    galleryCount.textContent = records.length > 0 ? `${records.length} image${records.length !== 1 ? 's' : ''}` : '';

    const newSet = new Set(newFilenames);
    for (const record of records) {
      gallery.appendChild(createCard(record, newSet.has(record.filename)));
    }

    // Scroll to top to see new images
    if (newFilenames.length > 0) window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ── Toast ─────────────────────────────────────────────────────────────────
  let toastTimer;
  function showToast(msg, isError = false) {
    clearTimeout(toastTimer);
    toast.textContent = msg;
    toast.className = 'show' + (isError ? ' error' : '');
    toastTimer = setTimeout(() => toast.className = '', 2500);
  }

  // ── Init ──────────────────────────────────────────────────────────────────
  loadGallery();
  promptInput.focus();
</script>
</body>
</html>
